// Variáveis globais
let uploadedFiles = [];
let dependentCounter = 1;
let experienceCounter = 1;
let generatedPdf = null;

// Função para buscar endereço pelo CEP
async function buscarEnderecoPorCEP() {
    const cep = document.getElementById('cep').value.replace(/\D/g, '');
    if (cep.length !== 8) return;
    
    // Mostrar spinner de carregamento
    document.getElementById('cepLoader').style.display = 'block';
    
    try {
        const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
        const data = await response.json();
        
        if (data.erro) {
            showToast('CEP não encontrado!', 'error');
            return;
        }
        
        // Preencher os campos com os dados do CEP
        document.getElementById('logradouro').value = data.logradouro || '';
        document.getElementById('bairro').value = data.bairro || '';
        document.getElementById('cidade').value = data.localidade || '';
        document.getElementById('estado').value = data.uf || '';
        
        // Focar no campo de número
        document.getElementById('numero').focus();
        
        showToast('Endereço preenchido automaticamente!');
    } catch (error) {
        showToast('Erro ao buscar o endereço. Tente novamente.', 'error');
        console.error('Erro na busca de CEP:', error);
    } finally {
        // Ocultar spinner de carregamento
        document.getElementById('cepLoader').style.display = 'none';
    }
}

// Funções para dependentes
function addDependente() {
    dependentCounter++;
    const container = document.getElementById('dependentesContainer');
    const newDependente = document.createElement('div');
    newDependente.className = 'dependente-card';
    newDependente.innerHTML = `
        <div class="dependente-card-header">
            <div class="dependente-card-title">Dependente #${dependentCounter}</div>
            <button type="button" class="remove-dependente">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="form-row">
            <div class="form-group medium">
                <label>Nome Completo</label>
                <input type="text" name="dependenteNome[]">
            </div>
            <div class="form-group medium">
                <label>Parentesco</label>
                <select name="dependenteParentesco[]">
                    <option value="">Selecione</option>
                    <option value="conjuge">Cônjuge</option>
                    <option value="filho">Filho(a)</option>
                    <option value="pai">Pai</option>
                    <option value="mae">Mãe</option>
                    <option value="outro">Outro</option>
                </select>
            </div>
        </div>
        
        <div class="form-row">
            <div class="form-group small">
                <label>Data de Nascimento</label>
                <input type="date" name="dependenteNascimento[]">
            </div>
            <div class="form-group small">
                <label>CPF</label>
                <input type="text" name="dependenteCpf[]" placeholder="000.000.000-00">
            </div>
        </div>
    `;
    container.appendChild(newDependente);
    showToast('Dependente adicionado com sucesso!');
}

function updateDependenteTitles() {
    const dependentes = document.querySelectorAll('.dependente-card-title');
    dependentes.forEach((title, index) => {
        title.textContent = `Dependente #${index + 1}`;
    });
    dependentCounter = dependentes.length;
}

// Funções para experiências
function addExperiencia() {
    experienceCounter++;
    const container = document.getElementById('experienciasContainer');
    const newExperiencia = document.createElement('div');
    newExperiencia.className = 'form-row experiencia-item';
    newExperiencia.innerHTML = `
        <div class="form-group medium">
            <label class="required">Empresa</label>
            <input type="text" name="empresa[]" required>
        </div>
        <div class="form-group medium">
            <label class="required">Cargo</label>
            <input type="text" name="cargo[]" required>
        </div>
        <div class="form-group small">
            <label class="required">Data Início</label>
            <input type="date" name="dataInicio[]" required>
        </div>
        <div class="form-group small">
            <label>Data Término</label>
            <input type="date" name="dataTermino[]">
        </div>
        <div class="form-group small">
            <label>&nbsp;</label>
            <button type="button" class="btn-remove remove-experiencia"><i class="fas fa-trash"></i> Remover</button>
        </div>
    `;
    container.appendChild(newExperiencia);
    showToast('Experiência adicionada com sucesso!');
}

function updateExperienciaTitles() {
    const experiencias = document.querySelectorAll('.experiencia-item');
    experienceCounter = experiencias.length;
}

// Funções para upload de arquivos
function triggerFileInput() {
    document.getElementById('fileInput').click();
}

function handleFileSelect(e) {
    const files = e.target.files;
    handleFiles(files);
}

function handleDragOver(e) {
    e.preventDefault();
    e.stopPropagation();
    e.dataTransfer.dropEffect = 'copy';
    document.getElementById('dropArea').style.borderColor = '#1a2980';
    document.getElementById('dropArea').style.backgroundColor = '#d1ecff';
}

function handleFileDrop(e) {
    e.preventDefault();
    e.stopPropagation();
    document.getElementById('dropArea').style.borderColor = '#ced4da';
    document.getElementById('dropArea').style.backgroundColor = '#f8f9fa';
    
    const files = e.dataTransfer.files;
    handleFiles(files);
}

function handleFiles(files) {
    if (files.length === 0) return;
    
    uploadedFiles = Array.from(files);
    updateFileList();
    showToast(`${files.length} arquivo(s) selecionado(s) com sucesso!`);
}

function updateFileList() {
    const fileList = document.getElementById('fileList');
    fileList.innerHTML = '';
    
    if (uploadedFiles.length === 0) {
        fileList.innerHTML = `
            <div class="file-item">
                <div class="file-info">
                    <i class="fas fa-file-alt file-icon"></i>
                    <div>
                        <div class="file-name">Nenhum arquivo selecionado</div>
                        <div class="file-size">Faça upload dos documentos necessários</div>
                    </div>
                </div>
            </div>
        `;
        return;
    }
    
    uploadedFiles.forEach((file, index) => {
        const fileSize = formatFileSize(file.size);
        const fileExtension = file.name.split('.').pop().toLowerCase();
        let iconClass = 'fas fa-file';
        
        if (['pdf'].includes(fileExtension)) {
            iconClass = 'fas fa-file-pdf';
        } else if (['jpg', 'jpeg', 'png', 'gif'].includes(fileExtension)) {
            iconClass = 'fas fa-file-image';
        } else if (['doc', 'docx'].includes(fileExtension)) {
            iconClass = 'fas fa-file-word';
        }
        
        const fileItem = document.createElement('div');
        fileItem.className = 'file-item';
        fileItem.innerHTML = `
            <div class="file-info">
                <i class="${iconClass} file-icon"></i>
                <div>
                    <div class="file-name">${file.name}</div>
                    <div class="file-size">${fileSize}</div>
                </div>
            </div>
            <button type="button" class="file-remove" data-index="${index}">
                <i class="fas fa-times"></i>
            </button>
        `;
        fileList.appendChild(fileItem);
    });
    
    // Adicionar evento de remoção
    document.querySelectorAll('.file-remove').forEach(button => {
        button.addEventListener('click', function() {
            const index = parseInt(this.getAttribute('data-index'));
            uploadedFiles.splice(index, 1);
            updateFileList();
        });
    });
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// Função para gerar PDF
function generatePdf() {
    if (!validateForm()) return;
    
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    // Configurações do documento
    doc.setFontSize(20);
    doc.setTextColor(26, 41, 128);
    doc.text('FICHA CADASTRAL', 105, 20, null, null, 'center');
    
    doc.setFontSize(12);
    doc.setTextColor(0, 0, 0);
    doc.text(`Gerado em: ${new Date().toLocaleString()}`, 105, 28, null, null, 'center');
    
    // Adicionar linha divisória
    doc.setDrawColor(26, 41, 128);
    doc.setLineWidth(0.5);
    doc.line(20, 35, 190, 35);
    
    // Dados Pessoais
    doc.setFontSize(14);
    doc.setTextColor(26, 41, 128);
    doc.text('DADOS PESSOAIS', 20, 45);
    
    doc.setFontSize(12);
    doc.setTextColor(0, 0, 0);
    doc.text(`Nome Completo: ${document.getElementById('nome').value}`, 20, 55);
    doc.text(`CPF: ${document.getElementById('cpf').value}`, 20, 65);
    doc.text(`RG: ${document.getElementById('rg').value}`, 20, 75);
    doc.text(`Órgão Emissor: ${document.getElementById('orgaoEmissor').value}`, 20, 85);
    doc.text(`Data de Emissão: ${formatDate(document.getElementById('dataEmissao').value)}`, 110, 85);
    doc.text(`Data de Nascimento: ${formatDate(document.getElementById('dataNascimento').value)}`, 20, 95);
    doc.text(`Naturalidade: ${document.getElementById('naturalidade').value}`, 110, 95);
    doc.text(`Nacionalidade: ${document.getElementById('nacionalidade').value}`, 20, 105);
    doc.text(`Nome do Pai: ${document.getElementById('nomePai').value || 'Não informado'}`, 20, 115);
    doc.text(`Nome da Mãe: ${document.getElementById('nomeMae').value}`, 20, 125);
    doc.text(`Estado Civil: ${document.getElementById('estadoCivil').value}`, 110, 125);
    doc.text(`Gênero: ${document.getElementById('genero').value}`, 20, 135);
    doc.text(`Tipo Sanguíneo: ${document.getElementById('tipoSanguineo').value || 'Não informado'}`, 110, 135);
    
    // Endereço
    doc.addPage();
    doc.setFontSize(14);
    doc.setTextColor(26, 41, 128);
    doc.text('ENDEREÇO', 20, 20);
    
    doc.setFontSize(12);
    doc.setTextColor(0, 0, 0);
    doc.text(`CEP: ${document.getElementById('cep').value}`, 20, 30);
    doc.text(`Logradouro: ${document.getElementById('logradouro').value}`, 20, 40);
    doc.text(`Número: ${document.getElementById('numero').value}`, 110, 40);
    doc.text(`Complemento: ${document.getElementById('complemento').value || 'Não informado'}`, 20, 50);
    doc.text(`Bairro: ${document.getElementById('bairro').value}`, 110, 50);
    doc.text(`Cidade: ${document.getElementById('cidade').value}`, 20, 60);
    doc.text(`Estado: ${document.getElementById('estado').value}`, 110, 60);
    
    // Contato
    doc.setFontSize(14);
    doc.setTextColor(26, 41, 128);
    doc.text('CONTATO', 20, 80);
    
    doc.setFontSize(12);
    doc.setTextColor(0, 0, 0);
    doc.text(`Celular 1: ${document.getElementById('celular1').value}`, 20, 90);
    doc.text(`Celular 2: ${document.getElementById('celular2').value || 'Não informado'}`, 110, 90);
    doc.text(`E-mail: ${document.getElementById('email').value}`, 20, 100);
    
    // Formação Acadêmica
    doc.addPage();
    doc.setFontSize(14);
    doc.setTextColor(26, 41, 128);
    doc.text('FORMAÇÃO ACADÊMICA', 20, 20);
    
    doc.setFontSize(12);
    doc.setTextColor(0, 0, 0);
    doc.text(`Escolaridade: ${document.getElementById('escolaridade').value}`, 20, 30);
    doc.text(`Curso Superior: ${document.getElementById('curso').value || 'Não informado'}`, 20, 40);
    doc.text(`Instituição de Ensino: ${document.getElementById('instituicao').value || 'Não informado'}`, 20, 50);
    doc.text(`Ano de Conclusão: ${document.getElementById('anoConclusao').value || 'Não informado'}`, 20, 60);
    
    // Experiências Profissionais
    doc.setFontSize(14);
    doc.setTextColor(26, 41, 128);
    doc.text('EXPERIÊNCIAS PROFISSIONAIS', 20, 80);
    
    let yPos = 90;
    document.querySelectorAll('.experiencia-item').forEach((exp, index) => {
        const inputs = exp.querySelectorAll('input');
        doc.text(`Experiência ${index + 1}:`, 20, yPos);
        doc.text(`Empresa: ${inputs[0].value}`, 30, yPos + 10);
        doc.text(`Cargo: ${inputs[1].value}`, 30, yPos + 20);
        doc.text(`Data Início: ${formatDate(inputs[2].value)}`, 30, yPos + 30);
        doc.text(`Data Término: ${inputs[3].value ? formatDate(inputs[3].value) : 'Atual'}`, 110, yPos + 30);
        yPos += 40;
    });
    
    // Dependentes
    doc.addPage();
    doc.setFontSize(14);
    doc.setTextColor(26, 41, 128);
    doc.text('DEPENDENTES', 20, 20);
    
    yPos = 30;
    document.querySelectorAll('.dependente-card').forEach((dep, index) => {
        const inputs = dep.querySelectorAll('input, select');
        doc.text(`Dependente ${index + 1}:`, 20, yPos);
        doc.text(`Nome: ${inputs[0].value}`, 30, yPos + 10);
        doc.text(`Parentesco: ${inputs[1].value || 'Não informado'}`, 30, yPos + 20);
        doc.text(`Data de Nascimento: ${inputs[2].value ? formatDate(inputs[2].value) : 'Não informada'}`, 30, yPos + 30);
        doc.text(`CPF: ${inputs[3].value || 'Não informado'}`, 110, yPos + 30);
        yPos += 40;
    });
    
    // Documentos
    doc.setFontSize(14);
    doc.setTextColor(26, 41, 128);
    doc.text('DOCUMENTOS ANEXADOS', 20, yPos + 20);
    
    yPos += 30;
    if (uploadedFiles.length > 0) {
        uploadedFiles.forEach((file, index) => {
            doc.text(`${index + 1}. ${file.name} (${formatFileSize(file.size)})`, 20, yPos);
            yPos += 10;
        });
    } else {
        doc.text('Nenhum documento anexado', 20, yPos);
    }
    
    // Declarações
    doc.addPage();
    doc.setFontSize(14);
    doc.setTextColor(26, 41, 128);
    doc.text('DECLARAÇÕES', 20, 20);
    
    doc.setFontSize(12);
    doc.setTextColor(0, 0, 0);
    doc.text('Declaro que as informações fornecidas são verdadeiras e estou ciente que falsas declarações sujeitam-me às penalidades legais.', 20, 30);
    doc.text(`Data: ${formatDate(document.getElementById('dataDeclaracao').value) || '________'}`, 20, 40);
    doc.text(`Cidade: ${document.getElementById('cidadeDeclaracao').value || '________'}`, 110, 40);
    
    doc.text('Autorizo a empresa a utilizar minhas informações para fins de registro e conformidade legal.', 20, 60);
    doc.text(`Data: ${formatDate(document.getElementById('dataAutorizacao').value) || '________'}`, 20, 70);
    doc.text(`Cidade: ${document.getElementById('cidadeAutorizacao').value || '________'}`, 110, 70);
    
    // Rodapé
    doc.setFontSize(10);
    doc.setTextColor(100, 100, 100);
    doc.text('Documento gerado automaticamente pelo sistema de cadastro', 105, 280, null, null, 'center');
    
    // Salvar o PDF para uso posterior
    generatedPdf = doc.output('blob');
    
    // Exibir preview do PDF
    showPdfPreview();
}

// Função para formatar data
function formatDate(dateString) {
    if (!dateString) return '';
    const date = new Date(dateString);
    return date.toLocaleDateString('pt-BR');
}

// Função para exibir preview do PDF
function showPdfPreview() {
    const pdfUrl = URL.createObjectURL(generatedPdf);
    const pdfPreviewBody = document.getElementById('pdfPreviewBody');
    
    // Limpar conteúdo anterior
    pdfPreviewBody.innerHTML = '';
    
    // Criar iframe para exibir o PDF
    const iframe = document.createElement('iframe');
    iframe.src = pdfUrl;
    iframe.width = '100%';
    iframe.height = '100%';
    iframe.style.border = 'none';
    
    pdfPreviewBody.appendChild(iframe);
    document.getElementById('pdfPreview').style.display = 'flex';
}

// Função para baixar o PDF
function downloadPdf() {
    const pdfUrl = URL.createObjectURL(generatedPdf);
    const a = document.createElement('a');
    a.href = pdfUrl;
    a.download = 'ficha_cadastral.pdf';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(pdfUrl); // Limpar o objeto URL
    showToast('PDF baixado com sucesso!');
}

// Função para enviar para WhatsApp
function sendPdfToWhatsApp() {
    if (!generatedPdf) return;
    
    // Baixar o PDF primeiro
    downloadPdf();
    
    // Mensagem padrão
    const nome = document.getElementById('nome').value;
    const defaultMessage = `Olá, segue em anexo a ficha cadastral de *${nome}*.\n\nDados principais:\n- CPF: ${document.getElementById('cpf').value}\n- Celular: ${document.getElementById('celular1').value}\n\nPor favor, confira o documento anexo.`;
    
    // Codificar a mensagem para URL
    const encodedMessage = encodeURIComponent(defaultMessage);
    
    // Número de WhatsApp formatado (11 96838-0160)
    const whatsappNumber = '5511968380160';
    
    // Criar link do WhatsApp com mensagem
    const whatsappUrl = `https://wa.me/${whatsappNumber}?text=${encodedMessage}`;
    
    // Abrir em nova aba
    window.open(whatsappUrl, '_blank');
    showToast('Abrindo WhatsApp para envio do PDF...');
    
    // Fechar o preview
    document.getElementById('pdfPreview').style.display = 'none';
}

// Função para enviar para WhatsApp diretamente
function sendViaWhatsApp() {
    if (!validateForm()) return;
    
    // Primeiro gerar o PDF
    generatePdf();
    
    // Depois enviar para WhatsApp
    setTimeout(() => {
        if (generatedPdf) {
            sendPdfToWhatsApp();
        }
    }, 500);
}

function submitForm() {
    if (validateForm()) {
        document.getElementById('successMessage').style.display = 'block';
        showToast('Formulário enviado com sucesso!');
        
        // Scroll para a mensagem de sucesso
        document.getElementById('successMessage').scrollIntoView({ behavior: 'smooth' });
    }
}

// Funções de validação
function validateForm() {
    let isValid = true;
    
    // Resetar erros
    document.querySelectorAll('.error-message').forEach(el => {
        el.style.display = 'none';
    });
    document.querySelectorAll('input, select').forEach(el => {
        el.classList.remove('input-error');
    });
    
    // Validar campos obrigatórios
    const requiredFields = document.querySelectorAll('[required]');
    requiredFields.forEach(field => {
        if (!field.value.trim()) {
            isValid = false;
            field.classList.add('input-error');
            
            // Mostrar mensagem de erro se existir
            const errorId = field.id + '-error';
            const errorElement = document.getElementById(errorId);
            if (errorElement) {
                errorElement.style.display = 'block';
            }
        }
    });
    
    // Validação especial para CPF
    const cpf = document.getElementById('cpf').value.replace(/\D/g, '');
    if (cpf.length !== 11) {
        isValid = false;
        document.getElementById('cpf').classList.add('input-error');
        document.getElementById('cpf-error').style.display = 'block';
    }
    
    // Validação especial para e-mail
    const email = document.getElementById('email').value;
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (email && !emailRegex.test(email)) {
        isValid = false;
        document.getElementById('email').classList.add('input-error');
    }
    
    return isValid;
}

// Função auxiliar para mostrar mensagens
function showToast(message, type = 'success') {
    const toast = document.getElementById('toast');
    const toastMessage = document.getElementById('toastMessage');
    
    toastMessage.textContent = message;
    toast.style.backgroundColor = type === 'error' ? '#f44336' : 
                                  type === 'info' ? '#2196F3' : '#4CAF50';
    toast.style.display = 'flex';
    
    setTimeout(() => {
        toast.style.display = 'none';
    }, 3000);
}

// Configurar máscaras de entrada
function setupInputMasks() {
    // Configurar máscara para CPF
    const cpfInput = document.getElementById('cpf');
    cpfInput.addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        if (value.length > 11) value = value.slice(0, 11);
        
        if (value.length > 9) {
            value = value.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
        } else if (value.length > 6) {
            value = value.replace(/(\d{3})(\d{3})(\d+)/, '$1.$2.$3');
        } else if (value.length > 3) {
            value = value.replace(/(\d{3})(\d+)/, '$1.$2');
        }
        e.target.value = value;
    });
    
    // Configurar máscara para telefone
    const phoneInputs = document.querySelectorAll('input[type="tel"]');
    phoneInputs.forEach(input => {
        input.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 11) value = value.slice(0, 11);
            
            if (value.length > 10) {
                value = value.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
            } else if (value.length > 6) {
                value = value.replace(/(\d{2})(\d{4})(\d+)/, '($1) $2-$3');
            } else if (value.length > 2) {
                value = value.replace(/(\d{2})(\d+)/, '($1) $2');
            }
            e.target.value = value;
        });
    });
    
    // Configurar máscara para CEP
    const cepInput = document.getElementById('cep');
    cepInput.addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        if (value.length > 8) value = value.slice(0, 8);
        
        if (value.length > 5) {
            value = value.replace(/(\d{5})(\d+)/, '$1-$2');
        }
        e.target.value = value;
        
        // Buscar endereço quando o CEP estiver completo
        if (value.length === 8) {
            buscarEnderecoPorCEP();
        }
    });
}

function setupEventListeners() {
    // Botão para adicionar dependente
    document.getElementById('addDependente').addEventListener('click', addDependente);
    
    // Botão para adicionar experiência
    document.getElementById('addExperiencia').addEventListener('click', addExperiencia);
    
    // Upload de arquivos
    document.getElementById('uploadBtn').addEventListener('click', triggerFileInput);
    document.getElementById('fileInput').addEventListener('change', handleFileSelect);
    document.getElementById('dropArea').addEventListener('dragover', handleDragOver);
    document.getElementById('dropArea').addEventListener('drop', handleFileDrop);
    document.getElementById('dropArea').addEventListener('click', triggerFileInput);
    
    // Botões de ação
    document.getElementById('generatePdf').addEventListener('click', generatePdf);
    document.getElementById('sendWhatsApp').addEventListener('click', sendViaWhatsApp);
    document.getElementById('submitForm').addEventListener('click', submitForm);
    
    // Botões do preview do PDF
    document.getElementById('downloadPdf').addEventListener('click', downloadPdf);
    document.getElementById('sendPdfWhatsApp').addEventListener('click', sendPdfToWhatsApp);
    document.getElementById('closePdfPreview').addEventListener('click', () => {
        document.getElementById('pdfPreview').style.display = 'none';
    });
    
    // Remover dependentes e experiências (delegação de eventos)
    document.getElementById('dependentesContainer').addEventListener('click', function(e) {
        if (e.target.closest('.remove-dependente')) {
            e.target.closest('.dependente-card').remove();
            updateDependenteTitles();
            showToast('Dependente removido com sucesso!');
        }
    });
    
    document.getElementById('experienciasContainer').addEventListener('click', function(e) {
        if (e.target.closest('.remove-experiencia')) {
            e.target.closest('.form-row').remove();
            updateExperienciaTitles();
            showToast('Experiência removida com sucesso!');
        }
    });
}

// Inicialização quando o DOM estiver carregado
document.addEventListener('DOMContentLoaded', function() {
    setupInputMasks();
    setupEventListeners();
    
    // Inicializar lista de arquivos
    updateFileList();
});
