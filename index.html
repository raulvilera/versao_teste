<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro Completo com Envio Automático</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* ... (todo o CSS permanece igual) ... */
    </style>
</head>
<body>
    <div class="container">
        <!-- ... (todo o HTML permanece igual) ... -->
    </div>
    
    <!-- Modal de confirmação -->
    <div class="whatsapp-modal" id="whatsappModal">
        <div class="modal-content">
            <h2><i class="fab fa-whatsapp"></i> Enviar via WhatsApp</h2>
            <p>O formulário será convertido em PDF e enviado automaticamente para o escritório responsável.</p>
            <p>Deseja confirmar o envio?</p>
            <div class="modal-buttons">
                <button class="modal-btn cancel" id="cancelWhatsApp">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button class="modal-btn send" id="confirmSend">
                    <i class="fab fa-whatsapp"></i> Confirmar Envio
                </button>
            </div>
        </div>
    </div>
    
    <!-- Overlay de envio -->
    <div class="sending-overlay" id="sendingOverlay">
        <div class="sending-spinner"></div>
        <div class="sending-text">Enviando formulário...</div>
        <div class="sending-subtext">Aguarde enquanto enviamos seus dados para o escritório</div>
    </div>
    
    <div class="toast" id="toast">
        <i class="fas fa-check-circle"></i> <span id="toastMessage">Operação realizada com sucesso!</span>
    </div>
    
    <script>
        // Variáveis globais
        let uploadedFiles = [];
        let dependentCounter = 1;
        let experienceCounter = 1;
        
        // Elementos DOM
        const whatsappModal = document.getElementById('whatsappModal');
        const sendingOverlay = document.getElementById('sendingOverlay');
        
        // Número do escritório para envio via WhatsApp
        const OFFICE_WHATSAPP_NUMBER = "5511969315304"; // (11)96931-5304
        
        // Funções para dependentes
        function addDependente() {
            dependentCounter++;
            const container = document.getElementById('dependentesContainer');
            const newDependente = document.createElement('div');
            newDependente.className = 'dependente-item';
            newDependente.innerHTML = `
                <div class="dependente-header">
                    <div class="dependente-title">Dependente #${dependentCounter}</div>
                    <button type="button" class="btn-remove remove-dependente"><i class="fas fa-trash"></i></button>
                </div>
                
                <div class="form-row">
                    <div class="form-group medium">
                        <label>Nome Completo</label>
                        <input type="text" name="dependenteNome[]">
                    </div>
                    <div class="form-group medium">
                        <label>Parentesco</label>
                        <select name="dependenteParentesco[]">
                            <option value="">Selecione</option>
                            <option value="conjuge">Cônjuge</option>
                            <option value="filho">Filho(a)</option>
                            <option value="pai">Pai</option>
                            <option value="mae">Mãe</option>
                            <option value="outro">Outro</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group small">
                        <label>Data de Nascimento</label>
                        <input type="date" name="dependenteNascimento[]">
                    </div>
                    <div class="form-group small">
                        <label>CPF</label>
                        <input type="text" name="dependenteCpf[]" placeholder="000.000.000-00">
                    </div>
                </div>
            `;
            container.appendChild(newDependente);
            showToast('Dependente adicionado com sucesso!');
        }
        
        function updateDependenteTitles() {
            const dependentes = document.querySelectorAll('.dependente-title');
            dependentes.forEach((title, index) => {
                title.textContent = `Dependente #${index + 1}`;
            });
            dependentCounter = dependentes.length;
        }
        
        // Funções para experiências
        function addExperiencia() {
            experienceCounter++;
            const container = document.getElementById('experienciasContainer');
            const newExperiencia = document.createElement('div');
            newExperiencia.className = 'form-row experiencia-item';
            newExperiencia.innerHTML = `
                <div class="form-group medium">
                    <label class="required">Empresa</label>
                    <input type="text" name="empresa[]" required>
                </div>
                <div class="form-group medium">
                    <label class="required">Cargo</label>
                    <input type="text" name="cargo[]" required>
                </div>
                <div class="form-group small">
                    <label class="required">Data Início</label>
                    <input type="date" name="dataInicio[]" required>
                </div>
                <div class="form-group small">
                    <label>Data Término</label>
                    <input type="date" name="dataTermino[]">
                </div>
                <div class="form-group small">
                    <label>&nbsp;</label>
                    <button type="button" class="btn-remove remove-experiencia"><i class="fas fa-trash"></i> Remover</button>
                </div>
            `;
            container.appendChild(newExperiencia);
            showToast('Experiência adicionada com sucesso!');
        }
        
        function updateExperienciaTitles() {
            const experiencias = document.querySelectorAll('.experiencia-item');
            experienceCounter = experiencias.length;
        }
        
        // Funções para upload de arquivos
        function triggerFileInput() {
            document.getElementById('fileInput').click();
        }
        
        function handleFileSelect(e) {
            const files = e.target.files;
            handleFiles(files);
        }
        
        function handleDragOver(e) {
            e.preventDefault();
            e.stopPropagation();
            e.dataTransfer.dropEffect = 'copy';
            document.getElementById('dropArea').style.borderColor = '#1a2980';
            document.getElementById('dropArea').style.backgroundColor = '#d1ecff';
        }
        
        function handleFileDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            document.getElementById('dropArea').style.borderColor = '#ced4da';
            document.getElementById('dropArea').style.backgroundColor = '#f8f9fa';
            
            const files = e.dataTransfer.files;
            handleFiles(files);
        }
        
        function handleFiles(files) {
            if (files.length === 0) return;
            
            uploadedFiles = Array.from(files);
            updateFileList();
            showToast(`${files.length} arquivo(s) selecionado(s) com sucesso!`);
        }
        
        function updateFileList() {
            const fileList = document.getElementById('fileList');
            fileList.innerHTML = '';
            
            if (uploadedFiles.length === 0) {
                fileList.innerHTML = `
                    <div class="file-item">
                        <div class="file-info">
                            <i class="fas fa-file-alt file-icon"></i>
                            <div>
                                <div class="file-name">Nenhum arquivo selecionado</div>
                                <div class="file-size">Faça upload dos documentos necessários</div>
                            </div>
                        </div>
                    </div>
                `;
                return;
            }
            
            uploadedFiles.forEach((file, index) => {
                const fileSize = formatFileSize(file.size);
                const fileExtension = file.name.split('.').pop().toLowerCase();
                let iconClass = 'fas fa-file';
                
                if (['pdf'].includes(fileExtension)) {
                    iconClass = 'fas fa-file-pdf';
                } else if (['jpg', 'jpeg', 'png', 'gif'].includes(fileExtension)) {
                    iconClass = 'fas fa-file-image';
                } else if (['doc', 'docx'].includes(fileExtension)) {
                    iconClass = 'fas fa-file-word';
                }
                
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `
                    <div class="file-info">
                        <i class="${iconClass} file-icon"></i>
                        <div>
                            <div class="file-name">${file.name}</div>
                            <div class="file-size">${fileSize}</div>
                        </div>
                    </div>
                    <button type="button" class="file-remove" data-index="${index}">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                fileList.appendChild(fileItem);
            });
            
            // Adicionar evento de remoção
            document.querySelectorAll('.file-remove').forEach(button => {
                button.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    uploadedFiles.splice(index, 1);
                    updateFileList();
                });
            });
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // Gerar PDF do formulário
        async function generatePDF() {
            return new Promise((resolve, reject) => {
                const card = document.querySelector('.card');
                
                html2canvas(card, {
                    scale: 2,
                    useCORS: true
                }).then(canvas => {
                    const imgData = canvas.toDataURL('image/jpeg', 1.0);
                    const pdf = new jspdf.jsPDF('p', 'mm', 'a4');
                    const imgWidth = pdf.internal.pageSize.getWidth();
                    const imgHeight = canvas.height * imgWidth / canvas.width;
                    
                    pdf.addImage(imgData, 'JPEG', 0, 0, imgWidth, imgHeight);
                    
                    // Adicionar dados extras ao PDF
                    pdf.setFontSize(12);
                    pdf.text('Formulário enviado automaticamente pelo sistema', 20, imgHeight + 20);
                    pdf.text(`Data do envio: ${new Date().toLocaleString()}`, 20, imgHeight + 30);
                    
                    const pdfBlob = pdf.output('blob');
                    resolve(pdfBlob);
                }).catch(error => {
                    reject(error);
                });
            });
        }
        
        // Enviar PDF via WhatsApp
        function sendPDFToOffice(pdfBlob) {
            return new Promise((resolve) => {
                // Criar um link para o PDF
                const pdfUrl = URL.createObjectURL(pdfBlob);
                
                // Criar um link de WhatsApp com o número e mensagem
                const whatsappUrl = `https://wa.me/${OFFICE_WHATSAPP_NUMBER}?text=${encodeURIComponent('Segue meu formulário cadastral em anexo:')}`;
                
                // Criar um link temporário para download e redirecionamento
                const a = document.createElement('a');
                a.href = whatsappUrl;
                a.target = '_blank';
                a.click();
                
                // Simular que o envio foi concluído
                setTimeout(() => {
                    resolve(true);
                }, 1000);
            });
        }
        
        // Enviar via WhatsApp (processo completo)
        async function sendViaWhatsApp() {
            if (!validateForm()) return;
            
            // Mostrar modal de confirmação
            whatsappModal.classList.add('active');
        }
        
        // Confirmar envio
        async function confirmSend() {
            whatsappModal.classList.remove('active');
            sendingOverlay.style.display = 'flex';
            
            try {
                // Gerar PDF
                const pdfBlob = await generatePDF();
                
                // Enviar para o WhatsApp do escritório
                const sendResult = await sendPDFToOffice(pdfBlob);
                
                if (sendResult) {
                    // Mostrar mensagem de sucesso
                    document.getElementById('successMessage').style.display = 'block';
                    showToast('Formulário enviado com sucesso para o escritório!');
                    
                    // Scroll para a mensagem de sucesso
                    document.getElementById('successMessage').scrollIntoView({ behavior: 'smooth' });
                }
            } catch (error) {
                console.error('Erro ao enviar formulário:', error);
                showToast('Erro ao enviar formulário. Tente novamente.', 'error');
            } finally {
                sendingOverlay.style.display = 'none';
            }
        }
        
        // Funções de validação
        function validateForm() {
            let isValid = true;
            
            // Resetar erros
            document.querySelectorAll('.error-message').forEach(el => {
                el.style.display = 'none';
            });
            document.querySelectorAll('input, select').forEach(el => {
                el.classList.remove('input-error');
            });
            
            // Validar campos obrigatórios
            const requiredFields = document.querySelectorAll('[required]');
            requiredFields.forEach(field => {
                if (!field.value.trim()) {
                    isValid = false;
                    field.classList.add('input-error');
                    
                    // Mostrar mensagem de erro se existir
                    const errorId = field.id + '-error';
                    const errorElement = document.getElementById(errorId);
                    if (errorElement) {
                        errorElement.style.display = 'block';
                    }
                }
            });
            
            // Validação especial para CPF
            const cpf = document.getElementById('cpf').value.replace(/\D/g, '');
            if (cpf.length !== 11) {
                isValid = false;
                document.getElementById('cpf').classList.add('input-error');
                document.getElementById('cpf-error').style.display = 'block';
            }
            
            // Validação especial para e-mail
            const email = document.getElementById('email').value;
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (email && !emailRegex.test(email)) {
                isValid = false;
                document.getElementById('email').classList.add('input-error');
            }
            
            return isValid;
        }
        
        // Função auxiliar para mostrar mensagens
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            
            toastMessage.textContent = message;
            toast.style.backgroundColor = type === 'error' ? '#f44336' : 
                                          type === 'info' ? '#2196F3' : '#4CAF50';
            toast.style.display = 'flex';
            
            setTimeout(() => {
                toast.style.display = 'none';
            }, 3000);
        }
        
        // Configurar máscaras de entrada
        function setupInputMasks() {
            // Configurar máscara para CPF
            const cpfInput = document.getElementById('cpf');
            cpfInput.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length > 11) value = value.slice(0, 11);
                
                if (value.length > 9) {
                    value = value.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
                } else if (value.length > 6) {
                    value = value.replace(/(\d{3})(\d{3})(\d+)/, '$1.$2.$3');
                } else if (value.length > 3) {
                    value = value.replace(/(\d{3})(\d+)/, '$1.$2');
                }
                e.target.value = value;
            });
            
            // Configurar máscara para telefone
            const phoneInputs = document.querySelectorAll('input[type="tel"]');
            phoneInputs.forEach(input => {
                input.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\D/g, '');
                    if (value.length > 11) value = value.slice(0, 11);
                    
                    if (value.length > 10) {
                        value = value.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
                    } else if (value.length > 6) {
                        value = value.replace(/(\d{2})(\d{4})(\d+)/, '($1) $2-$3');
                    } else if (value.length > 2) {
                        value = value.replace(/(\d{2})(\d+)/, '($1) $2');
                    }
                    e.target.value = value;
                });
            });
            
            // Configurar máscara para CEP
            const cepInput = document.getElementById('cep');
            cepInput.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length > 8) value = value.slice(0, 8);
                
                if (value.length > 5) {
                    value = value.replace(/(\d{5})(\d+)/, '$1-$2');
                }
                e.target.value = value;
            });
        }
        
        function setupEventListeners() {
            // Botão para adicionar dependente
            document.getElementById('addDependente').addEventListener('click', addDependente);
            
            // Botão para adicionar experiência
            document.getElementById('addExperiencia').addEventListener('click', addExperiencia);
            
            // Upload de arquivos
            document.getElementById('uploadBtn').addEventListener('click', triggerFileInput);
            document.getElementById('fileInput').addEventListener('change', handleFileSelect);
            document.getElementById('dropArea').addEventListener('dragover', handleDragOver);
            document.getElementById('dropArea').addEventListener('drop', handleFileDrop);
            document.getElementById('dropArea').addEventListener('click', triggerFileInput);
            
            // Botões de ação
            document.getElementById('sendWhatsApp').addEventListener('click', sendViaWhatsApp);
            document.getElementById('submitForm').addEventListener('click', function(e) {
                e.preventDefault();
                sendViaWhatsApp();
            });
            
            // Botão para gerar PDF
            document.getElementById('generatePdf').addEventListener('click', async function() {
                try {
                    const pdfBlob = await generatePDF();
                    const pdfUrl = URL.createObjectURL(pdfBlob);
                    
                    const a = document.createElement('a');
                    a.href = pdfUrl;
                    a.download = 'formulario_cadastral.pdf';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    
                    showToast('PDF gerado e baixado com sucesso!');
                } catch (error) {
                    console.error('Erro ao gerar PDF:', error);
                    showToast('Erro ao gerar PDF. Tente novamente.', 'error');
                }
            });
            
            // Botões do modal WhatsApp
            document.getElementById('cancelWhatsApp').addEventListener('click', function() {
                whatsappModal.classList.remove('active');
            });
            
            document.getElementById('confirmSend').addEventListener('click', confirmSend);
            
            // Remover dependentes e experiências (delegação de eventos)
            document.getElementById('dependentesContainer').addEventListener('click', function(e) {
                if (e.target.closest('.remove-dependente')) {
                    e.target.closest('.dependente-item').remove();
                    updateDependenteTitles();
                    showToast('Dependente removido com sucesso!');
                }
            });
            
            document.getElementById('experienciasContainer').addEventListener('click', function(e) {
                if (e.target.closest('.remove-experiencia')) {
                    e.target.closest('.form-row').remove();
                    updateExperienciaTitles();
                    showToast('Experiência removida com sucesso!');
                }
            });
        }
        
        // Inicialização quando o DOM estiver carregado
        document.addEventListener('DOMContentLoaded', function() {
            setupInputMasks();
            setupEventListeners();
        });
    </script>
</body>
</html>
